// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Users & Auth
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  country       Country   @default(SA)
  currency      Currency  @default(SAR)
  telegramId    String?
  emailVerified DateTime?
  image         String?
  role          Role      @default(USER)

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Browser extension
  extensionApiKey String? @unique

  @@index([resetTokenExpiry])

  wishlist Wishlist[]
  alerts   PriceAlert[]
  searches SearchHistory[]
  accounts Account[]
  sessions Session[]

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  affiliateClicks      AffiliateClick[]
  cashbackTransactions CashbackTransaction[]
  stockNotifications   StockNotification[]
  storeReviews         StoreReview[]
  reviewHelpful        ReviewHelpful[]
  barcodeScans         BarcodeScan[]
  shoppingLists        ShoppingList[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum Role {
  USER
  ADMIN
}

enum Country {
  SA // Saudi Arabia
  EG // Egypt
  AE // UAE
  KW // Kuwait
}

enum Currency {
  SAR
  EGP
  AED
  KWD
  USD
}

// ============================================
// Products & Stores
// ============================================

model Store {
  id           String   @id @default(cuid())
  name         String
  nameAr       String
  slug         String   @unique
  domain       String   @unique
  logo         String?
  country      Country
  currency     Currency
  isActive     Boolean  @default(true)
  scrapeConfig Json? // CSS selectors, API endpoints

  affiliateTag  String?
  affiliateRate Decimal? @db.Decimal(5, 2)

  products        StoreProduct[]
  coupons         Coupon[]
  affiliateClicks AffiliateClick[]
  storeReviews    StoreReview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country, isActive])
  @@map("stores")
}

model Product {
  id          String  @id @default(cuid())
  name        String
  nameAr      String?
  slug        String  @unique
  barcode     String? @unique
  brand       String?
  category    String?
  image       String?
  description String? @db.Text

  storeProducts     StoreProduct[]
  wishlist          Wishlist[]
  alerts            PriceAlert[]
  searches          SearchHistory[]
  affiliateClicks   AffiliateClick[]
  barcodeScans      BarcodeScan[]
  shoppingListItems ShoppingListItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([barcode])
  @@map("products")
}

model StoreProduct {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  storeId   String
  store     Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)

  url           String
  price         Decimal  @db.Decimal(10, 2)
  currency      Currency
  priceUSD      Decimal  @db.Decimal(10, 2) // Normalized price
  originalPrice Decimal? @db.Decimal(10, 2) // Before discount
  discount      Int? // Percentage
  inStock       Boolean  @default(true)
  rating        Decimal? @db.Decimal(2, 1)
  reviewCount   Int?

  priceHistory       PriceHistory[]
  stockNotifications StockNotification[]
  stockHistory       StockHistory[]

  lastScraped DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([productId, storeId])
  @@index([price])
  @@index([priceUSD])
  @@index([url])
  @@index([storeId, inStock])
  @@map("store_products")
}

model PriceHistory {
  id             String       @id @default(cuid())
  storeProductId String
  storeProduct   StoreProduct @relation(fields: [storeProductId], references: [id], onDelete: Cascade)

  price    Decimal  @db.Decimal(10, 2)
  priceUSD Decimal  @db.Decimal(10, 2)
  currency Currency

  recordedAt DateTime @default(now())

  @@index([storeProductId, recordedAt])
  @@map("price_history")
}

// ============================================
// User Features
// ============================================

model Wishlist {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  targetPrice Decimal? @db.Decimal(10, 2) // Target price for notifications
  notes       String?  @db.Text

  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
  @@map("wishlists")
}

model PriceAlert {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  targetPrice Decimal   @db.Decimal(10, 2)
  currency    Currency
  isActive    Boolean   @default(true)
  triggered   Boolean   @default(false)
  triggeredAt DateTime?

  notifyEmail    Boolean @default(true)
  notifyTelegram Boolean @default(false)
  notifyPush     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, triggered])
  @@index([userId, isActive])
  @@map("price_alerts")
}

model SearchHistory {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  query   String
  results Int    @default(0)

  createdAt DateTime @default(now())

  @@index([query])
  @@map("search_history")
}

// ============================================
// Exchange Rates
// ============================================

model ExchangeRate {
  id           String   @id @default(cuid())
  fromCurrency Currency
  toCurrency   Currency @default(USD)
  rate         Decimal  @db.Decimal(10, 6)

  updatedAt DateTime @default(now())

  @@unique([fromCurrency, toCurrency])
  @@map("exchange_rates")
}

// ============================================
// Scrape Jobs
// ============================================

model ScrapeJob {
  id        String    @id @default(cuid())
  storeId   String?
  productId String?
  status    JobStatus @default(PENDING)
  type      JobType

  startedAt      DateTime?
  completedAt    DateTime?
  error          String?   @db.Text
  itemsProcessed Int       @default(0)

  createdAt DateTime @default(now())

  @@index([status])
  @@map("scrape_jobs")
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum JobType {
  FULL_SCRAPE
  PRODUCT_UPDATE
  PRICE_CHECK
  EXCHANGE_RATE
}

// ============================================
// Affiliate & Coupons
// ============================================

model AffiliateClick {
  id        String  @id @default(cuid())
  userId    String?
  storeId   String
  productId String?

  url       String
  referrer  String?
  userAgent String?
  ipHash    String // Hashed for privacy
  converted Boolean  @default(false)
  revenue   Decimal? @db.Decimal(10, 2)

  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  store   Store    @relation(fields: [storeId], references: [id])
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([storeId, createdAt])
  @@index([userId])
  @@index([converted])
  @@map("affiliate_clicks")
}

model Coupon {
  id      String @id @default(cuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id])

  code          String
  description   String
  descriptionAr String?
  discount      String // "10% OFF", "50 SAR OFF"
  minPurchase   Decimal? @db.Decimal(10, 2)
  maxDiscount   Decimal? @db.Decimal(10, 2)

  startDate  DateTime?
  endDate    DateTime?
  isActive   Boolean   @default(true)
  isVerified Boolean   @default(false)
  isFeatured Boolean   @default(false)
  usageCount Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId, isActive])
  @@map("coupons")
}

// ============================================
// Cashback System
// ============================================

model CashbackTransaction {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  affiliateClickId String?
  amount           Decimal        @db.Decimal(10, 2)
  currency         Currency
  status           CashbackStatus @default(PENDING)

  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId, status])
  @@map("cashback_transactions")
}

enum CashbackStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

// ============================================
// Stock Notifications
// ============================================

model StockNotification {
  id             String  @id @default(cuid())
  userId         String
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeProductId String
  storeProduct   StoreProduct @relation(fields: [storeProductId], references: [id], onDelete: Cascade)

  isActive       Boolean   @default(true)
  notifyEmail    Boolean   @default(true)
  notifyPush     Boolean   @default(false)
  lastNotifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, storeProductId])
  @@index([isActive])
  @@map("stock_notifications")
}

model StockHistory {
  id             String       @id @default(cuid())
  storeProductId String
  storeProduct   StoreProduct @relation(fields: [storeProductId], references: [id], onDelete: Cascade)

  inStock   Boolean
  checkedAt DateTime @default(now())

  @@index([storeProductId, checkedAt])
  @@map("stock_history")
}

// ============================================
// Store Reviews
// ============================================

model StoreReview {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeId String
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  rating  Int // 1-5
  title   String
  content String @db.Text
  pros    Json   @default("[]") // String array
  cons    Json   @default("[]") // String array

  deliveryRating Int? // 1-5
  priceRating    Int? // 1-5
  serviceRating  Int? // 1-5

  verifiedPurchase Boolean @default(false)
  helpfulCount     Int     @default(0)

  helpfulMarks ReviewHelpful[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, storeId])
  @@index([storeId, rating])
  @@map("store_reviews")
}

model ReviewHelpful {
  id       String @id @default(cuid())
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewId String
  review   StoreReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, reviewId])
  @@map("review_helpful")
}

// ============================================
// Barcode Scanner
// ============================================

model BarcodeScan {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  barcode   String
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  scannedAt DateTime @default(now())

  @@index([userId, scannedAt])
  @@index([barcode])
  @@map("barcode_scans")
}

// ============================================
// Shopping Lists
// ============================================

model ShoppingList {
  id          String  @id @default(cuid())
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String? @db.Text
  isPublic    Boolean @default(false)

  items ShoppingListItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isPublic])
  @@map("shopping_lists")
}

model ShoppingListItem {
  id        String       @id @default(cuid())
  listId    String
  list      ShoppingList @relation(fields: [listId], references: [id], onDelete: Cascade)
  productId String
  product   Product      @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity    Int     @default(1)
  notes       String? @db.Text
  isPurchased Boolean @default(false)

  addedAt DateTime @default(now())

  @@unique([listId, productId])
  @@index([listId])
  @@map("shopping_list_items")
}
